# Restaurants from Google Places API – How It Was Done & Plan for 247 Destinations

## How the current 3,500+ restaurants were added

### 1. **Source**
- **Google Places API (New)** – Text Search: `POST https://places.googleapis.com/v1/places:searchText`
- **Parameters**: `textQuery` (e.g. "restaurants in Aruba"), `includedType: 'restaurant'`, `maxResultCount: 20`, optional `locationBias` (lat,lng + 50 km radius)

### 2. **Per-destination flow**
1. **Search**: `searchRestaurants(query, location)` in `src/lib/googlePlacesApi.js`  
   - Query like `"restaurants in Aruba"`; location optional (e.g. `"12.5211,-69.9683"` for better bias).
2. **Details**: For each of the up to 20 places, `getPlaceDetails(placeId)` to get full fields (hours, reviews, etc.).
3. **Format**: `formatRestaurantData(place, destinationId)` → slug, name, address, rating, photos, cuisines, price, hours, etc.
4. **Upsert**: Insert or update in Supabase `restaurants` by `google_place_id`, with `destination_id` and 1 s delay between places for rate limiting.

### 3. **Where it runs**
- **CLI (one destination)**:  
  `node scripts/fetch-restaurants-from-google-places.js <destinationId> [query] [location]`  
  Example:  
  `node scripts/fetch-restaurants-from-google-places.js aruba "restaurants in Aruba" "12.5211,-69.9683"`
- **API**:  
  `POST /api/restaurants/fetch-google-places`  
  Body: `{ destinationId, query, location? }` or `{ destinationId, placeIds }`

### 4. **Destinations that had restaurants**
- **182 curated destinations** from `src/data/destinationsData.js`.
- Static list for metadata/SEO: `src/data/destinationsWithRestaurants.js` (generated by `scripts/generate-destinations-with-restaurants-list.js`, which currently uses “all 182 curated” as the list).

### 5. **Relevant files**
| File | Purpose |
|------|---------|
| `src/lib/googlePlacesApi.js` | `searchRestaurants`, `getPlaceDetails`, `formatRestaurantData` |
| `scripts/fetch-restaurants-from-google-places.js` | Single-destination CLI fetch + Supabase upsert |
| `app/api/restaurants/fetch-google-places/route.js` | API route for fetch by destination or by placeIds |
| `scripts/generate-destinations-with-restaurants-list.js` | Builds `DESTINATIONS_WITH_RESTAURANTS` from DB + curated list |
| `src/data/destinationsWithRestaurants.js` | Set of destination IDs that have restaurants (used in metadata) |

---

## Plan: Restaurants for all 247 featured destinations

### Current vs target
- **Before**: 182 curated destinations → ~3,500+ restaurants (≈20 per destination from one Text Search per destination).
- **Featured destinations**: **247** = same logic as `/destinations`:  
  **curated** (`destinationsData.js`) + **generated** (from `generated-destination-full-content.json` with `hasGuide` + image).  
  This is the same as `getFeaturedDestinations()` in `scripts/generate-airport-transfers-content.js`.
- **Gap**: ~65 featured destinations (the “generated” ones) do not have restaurants yet.

### Steps

1. **Batch script (new)**  
   - **Script**: `scripts/fetch-restaurants-all-featured-destinations.js`  
   - **Input**: All featured destinations from `getFeaturedDestinations()` (~247).  
   - **Behaviour**:  
     - For each destination: `query = "restaurants in {fullName}"`, optional `location` if we add coords later.  
     - Reuse same flow as single-destination script: search → details → format → upsert, 1 s between places.  
   - **Options**:  
     - `--only-new`: only destinations with 0 restaurants in DB (so ~65).  
     - `--test`: run for one destination (e.g. first generated one).  
     - `--limit N`: process only first N destinations.  
   - **Rate limiting**: Keep 1 s delay per place; optional delay between destinations (e.g. 2 s) to be safe.

2. **Coordinates (optional improvement)**  
   - Destinations in `destinationsData.js` do not have lat/lng.  
   - Text Search works without `locationBias`; adding lat/lng later (e.g. from Viator/geocoding) would improve relevance.  
   - Not required for the 247 rollout.

3. **Update “destinations with restaurants” list**  
   - After the batch, the DB will have restaurants for more than 182 destinations.  
   - **Change**: Update `scripts/generate-destinations-with-restaurants-list.js` so the static list is **all unique `destination_id` from the `restaurants` table** (or: featured destinations that have at least one restaurant in DB), instead of hardcoding “182 curated”.  
   - **Run**: `node scripts/generate-destinations-with-restaurants-list.js` after the batch.  
   - **Output**: `src/data/destinationsWithRestaurants.js` will then include all ~247 (or however many have restaurants), so metadata/sitemaps stay correct.

4. **API limits and cost**  
   - **Text Search**: 20 results per request per destination.  
   - **Place Details**: 1 call per place (up to 20 per destination).  
   - **Rough order**: 65 new destinations × (1 search + 20 details) ≈ 1,300 requests for “only new”; 247 × 21 ≈ 5,200 for “all featured”.  
   - Check Google Places (New) pricing and quotas; 1 s delay helps stay within rate limits.

5. **Execution order**  
   - Run batch:  
     `node scripts/fetch-restaurants-all-featured-destinations.js --only-new`  
     (or without `--only-new` to refresh all 247.)  
   - Then:  
     `node scripts/generate-destinations-with-restaurants-list.js`  
   - Commit updated `src/data/destinationsWithRestaurants.js`.

---

## Quick reference

- **Single destination (existing)**  
  `node scripts/fetch-restaurants-from-google-places.js <id> ["query"] ["lat,lng"]`

- **All featured, only destinations without restaurants (new)**  
  `node scripts/fetch-restaurants-all-featured-destinations.js --only-new`

- **All 247 featured, 100 restaurants per destination (default)**  
  `node scripts/fetch-restaurants-all-featured-destinations.js`

- **Use more of 50k calls: ~200 per destination**  
  `node scripts/fetch-restaurants-all-featured-destinations.js --max-per-destination 200`

- **Test one destination (new)**  
  `node scripts/fetch-restaurants-all-featured-destinations.js --test`

- **Regenerate static list after batch**  
  `node scripts/generate-destinations-with-restaurants-list.js`
